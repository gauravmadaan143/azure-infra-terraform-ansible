trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  terraformVersion: '1.6.6'
  terraform_folder: 'terraform'
  ansible_folder: 'ansible'
  location: 'westeurope'
  resource_group: 'demo-rg'
  vm_name: 'demo-vm'
  ssh_public_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDSgIiTUa…your_key_here…'

jobs:
- job: TerraformAndAnsible
  displayName: Terraform + Ansible
  steps:
    - checkout: self

    ### Install Terraform CLI locally
    - bash: |
        set -e
        echo "Downloading Terraform $(terraformVersion)..."
        rm -rf terraform terraform.zip
        curl -sSLo terraform.zip \
          https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
        unzip -o terraform.zip
        chmod +x terraform
        mkdir -p $HOME/bin
        mv terraform $HOME/bin/terraform
        rm terraform.zip
        export PATH="$HOME/bin:$PATH"
        echo "✅ Terraform installed:" 
        terraform -version
      displayName: Install Terraform CLI

    ### Terraform Init
    - bash: |
        set -e
        cd $(terraform_folder)
        terraform init
      displayName: Terraform Init

    ### Terraform Plan
    - bash: |
        set -e
        cd $(terraform_folder)
        terraform plan \
          -var="location=$(location)" \
          -var="resource_group_name=$(resource_group)" \
          -var="vm_name=$(vm_name)" \
          -var="ssh_public_key=$(ssh_public_key)"
      displayName: Terraform Plan

    ### Terraform Apply
    - bash: |
        set -e
        cd $(terraform_folder)
        terraform apply -auto-approve \
          -var="location=$(location)" \
          -var="resource_group_name=$(resource_group)" \
          -var="vm_name=$(vm_name)" \
          -var="ssh_public_key=$(ssh_public_key)"
      displayName: Terraform Apply

    ### Install & Run Ansible
    - bash: |
        set -e
        sudo apt-get update
        sudo apt-get install -y ansible
        cd $(ansible_folder)
        ansible-playbook -i inventory site.yml
      displayName: Configure NGINX via Ansible

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: Terraform-SP-Creds   # Your SP secrets variable group
- name: terraformVersion
  value: '1.6.6'
- name: terraform_folder
  value: 'terraform'
- name: ansible_folder
  value: 'ansible'
- name: location
  value: 'westeurope'
- name: resource_group_name
  value: 'demo-rg'
- name: vm_name
  value: 'demo-vm'
- name: ssh_public_key
  value: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDSgIiTUaJttDCYf0wLHqiSnq00iwH5RFFa8ukJiug+qdK0kgjKgtoABgJxF3nyXKoaFEuEq1+90ZtqEt7oQGMSaFGryhggGrNOdPSq3ZuLqlpBiiiH1aSQHxmPkOjLUR4y2jIh6pXL4VvEHRvXrf6woFeU+17wWalo+22RUs1iTvvJvBac9UytDnv6vIjujr4ALGqL9eBnss6Kk/dOifWx0lutFMJxTDYXOPtUOKuSBn3ZX+HGNtLHb2KViL29jbpqwu0kF23KBpUeds8YIYvKJkRci8S8s2U+WQliDqYzRGC87qCEYh43nS+5owGIeYTl3xt2tZFR0EjPdTm7s2Me+z6Pr7JYd17Q9E+m4cC0a+MQK3W/cOVl4/zD+2K5y1bfMovQ2OK2Bz/lyvsE29jtauL9ULa8KZ/81szYc9vV6dPD6602gdZ0Q5WwCE7jvzzC0ZfJeZ//Jtt4jlGc8Gg2av9QITvEMxmGEQDltPB4E9SIrodyrIV/CarXPteYQWyAAg+I1Nf+nX7esalLVAmincxnCW3YstZaO50N1djMd65ulaIJIrjoTbPVia9YKixeQAKb9RyFhkp6OjNNrNOD9GSyBNrT2bfBrqQ4LrRiPedRHEttX64lBJesxNImeCbpl96cqnAR+mHYG+78I4EzLL/6JTVI/M6dG3gvijho6Q== gauravmadaan143@gmail.com'
- name: my_ip_address
  value: '89.64.12.157'

jobs:
- job: DeployInfra
  displayName: "Terraform + Ansible Deployment"
  steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: "$(terraformVersion)"

    - task: Bash@3
      displayName: "Terraform Init"
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
      inputs:
        targetType: inline
        script: |
          cd $(Build.SourcesDirectory)/$(terraform_folder)
          terraform init

    - task: Bash@3
      displayName: "Terraform Plan"
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
        ssh_public_key: $(ssh_public_key) 
      inputs:
        targetType: inline
        script: |
          echo "SSH Public Key starts with: $(echo $ssh_public_key | cut -c1-40)..."
          displayName: "Debug SSH public key variable"
          cd $(Build.SourcesDirectory)/$(terraform_folder)
          terraform plan \
            -var="location=$(location)" \
            -var="resource_group_name=$(resource_group_name)" \
            -var="vm_name=$(vm_name)" \
            -var="ssh_public_key=$(ssh_public_key)" \
            -var="my_ip_address=$(my_ip_address)" \
            -var="client_id=$(ARM_CLIENT_ID)" \
            -var="client_secret=$(ARM_CLIENT_SECRET)" \
            -var="subscription_id=$(ARM_SUBSCRIPTION_ID)" \
            -var="tenant_id=$(ARM_TENANT_ID)"

    - task: Bash@3
      displayName: "Terraform Apply"
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
        ssh_public_key: $(ssh_public_key) 
      inputs:
        targetType: inline
        script: |
          echo "SSH Public Key starts with: $(echo $ssh_public_key | cut -c1-40)..."
          displayName: "Debug SSH public key variable"
          cd $(Build.SourcesDirectory)/$(terraform_folder)
          terraform apply -auto-approve \
            -var="location=$(location)" \
            -var="resource_group_name=$(resource_group_name)" \
            -var="vm_name=$(vm_name)" \
            -var="ssh_public_key=$(ssh_public_key)" \
            -var="my_ip_address=$(my_ip_address)" \
            -var="client_id=$(ARM_CLIENT_ID)" \
            -var="client_secret=$(ARM_CLIENT_SECRET)" \
            -var="subscription_id=$(ARM_SUBSCRIPTION_ID)" \
            -var="tenant_id=$(ARM_TENANT_ID)"
          
          echo "Fetching VM public IP output..."
          terraform output -raw vm_public_ip


    # ✅ Write SSH Private Key to ~/.ssh/id_rsa
    - task: Bash@3
      displayName: 'Write SSH private key to file'
      inputs:
        targetType: 'inline'
        script: |
          mkdir -p ~/.ssh
          echo '$(SSH_PRIVATE_KEY)' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "✅ SSH private key saved"

    - task: Bash@3
      displayName: 'Verify Terraform output'
      inputs:
        targetType: 'inline'
        script: |
          cd $(Build.SourcesDirectory)/$(terraform_folder)
          terraform output vm_public_ip || echo "No vm_public_ip output found"
      

    # ✅ Append dynamic VM public IP to existing inventory file
    - task: Bash@3
      displayName: 'Append VM IP to Ansible inventory file'
      inputs:
        targetType: 'inline'
        script: |
          VM_PUBLIC_IP=$(terraform output -raw vm_public_ip)

          if [ -z "$VM_PUBLIC_IP" ]; then
            echo "❌ ERROR: Terraform output 'vm_public_ip' is empty. Please verify your Terraform state and output."
            exit 1
          fi

          echo "✅ VM_PUBLIC_IP is $VM_PUBLIC_IP"

          mkdir -p ansible

          # Create inventory if missing
          if [ ! -f ansible/inventory ]; then
           echo "[linux_servers]" > ansible/inventory
          fi
          


          # Ensure group header exists
          if ! grep -q "^\[linux_servers\]" ansible/inventory; then
            echo "[linux_servers]" >> ansible/inventory
          fi

          # Avoid duplicate entries
          if ! grep -q "$VM_PUBLIC_IP" ansible/inventory; then
            echo "demo-vm ansible_host=$VM_PUBLIC_IP ansible_user=azureuser ansible_ssh_private_key_file=~/.ssh/id_rsa" >> ansible/inventory
          fi

          echo "📋 Final Inventory Content:"
          cat ansible/inventory

    # ✅ Install Ansible on RHEL & Run the Playbook
    - task: Bash@3
      displayName: "Install & Run Ansible"
      inputs:
        targetType: inline
        script: |
          echo "📦 Installing Ansible (RHEL 8)..."
          sudo apt-get update
          sudo apt-get install -y ansible
         
          echo "===== Inventory file contents ====="
          cat ansible/inventory
          echo "=================================="

          echo "🚀 Running Ansible Playbook..."
          cd ansible
          ansible-playbook -i inventory playbook.yaml
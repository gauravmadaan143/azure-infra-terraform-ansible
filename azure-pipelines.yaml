trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  terraformVersion: '1.6.6'
  terraform_folder: 'terraform'
  ansible_folder: 'ansible'
  resource_group: 'demo-rg'
  vm_name: 'demo-vm'
  location: 'westeurope'
  ssh_public_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDSgIiTUaJttDCYf0wLHqiSnq00iwH5RFFa8ukJiug+qdK0kgjKgtoABgJxF3nyXKoaFEuEq1+90ZtqEt7oQGMSaFGryhggGrNOdPSq3ZuLqlpBiiiH1aSQHxmPkOjLUR4y2jIh6pXL4VvEHRvXrf6woFeU+17wWalo+22RUs1iTvvJvBac9UytDnv6vIjujr4ALGqL9eBnss6Kk/dOifWx0lutFMJxTDYXOPtUOKuSBn3ZX+HGNtLHb2KViL29jbpqwu0kF23KBpUeds8YIYvKJkRci8S8s2U+WQliDqYzRGC87qCEYh43nS+5owGIeYTl3xt2tZFR0EjPdTm7s2Me+z6Pr7JYd17Q9E+m4cC0a+MQK3W/cOVl4/zD+2K5y1bfMovQ2OK2Bz/lyvsE29jtauL9ULa8KZ/81szYc9vV6dPD6602gdZ0Q5WwCE7jvzzC0ZfJeZ//Jtt4jlGc8Gg2av9QITvEMxmGEQDltPB4E9SIrodyrIV/CarXPteYQWyAAg+I1Nf+nX7esalLVAmincxnCW3YstZaO50N1djMd65ulaIJIrjoTbPVia9YKixeQAKb9RyFhkp6OjNNrNOD9GSyBNrT2bfBrqQ4LrRiPedRHEttX64lBJesxNImeCbpl96cqnAR+mHYG+78I4EzLL/6JTVI/M6dG3gvijho6Q== gauravmadaan143@gmail.com'

stages:

# Stage 1: Install Terraform CLI
- stage: InstallTerraform
  displayName: "Install Terraform CLI"
  jobs:
    - job: InstallTerraformJob
      steps:
        - checkout: self
        - script: |
            echo "Cleaning old terraform binary/directory if exists..."
            if [ -d "/usr/local/bin/terraform" ]; then
              sudo rm -rf /usr/local/bin/terraform
            elif [ -f "/usr/local/bin/terraform" ]; then
              sudo rm -f /usr/local/bin/terraform
            fi

            echo "Downloading Terraform version $(terraformVersion)..."
            curl -sLo terraform.zip https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip

            echo "Unzipping Terraform..."
            unzip -o -q terraform.zip

            echo "Moving terraform binary to /usr/local/bin/"
            sudo mv terraform /usr/local/bin/
            sudo chmod +x /usr/local/bin/terraform

            terraform -version
          displayName: "Install Terraform CLI"
          workingDirectory: $(Build.SourcesDirectory)

# Stage 2: Terraform Init
- stage: TerraformInit
  displayName: "Terraform Init"
  dependsOn: InstallTerraform
  jobs:
    - job: TerraformInitJob
      steps:
        - checkout: self
        - script: |
            cd $(terraform_folder)
            terraform init
          displayName: "Terraform Init"
          workingDirectory: $(Build.SourcesDirectory)

# Stage 3: Terraform Plan
- stage: TerraformPlan
  displayName: "Terraform Plan"
  dependsOn: TerraformInit
  jobs:
    - job: TerraformPlanJob
      steps:
        - checkout: self
        - script: |
            cd $(terraform_folder)
            terraform plan \
              -var="location=$(location)" \
              -var="resource_group_name=$(resource_group)" \
              -var="vm_name=$(vm_name)" \
              -var="ssh_public_key=$(ssh_public_key)"
          displayName: "Terraform Plan"
          workingDirectory: $(Build.SourcesDirectory)

# Stage 4: Terraform Apply
- stage: TerraformApply
  displayName: "Terraform Apply"
  dependsOn: TerraformPlan
  condition: succeeded()
  jobs:
    - job: TerraformApplyJob
      steps:
        - checkout: self
        - script: |
            cd $(terraform_folder)
            terraform apply \
              -var="location=$(location)" \
              -var="resource_group_name=$(resource_group)" \
              -var="vm_name=$(vm_name)" \
              -var="ssh_public_key=$(ssh_public_key)" \
              -auto-approve
          displayName: "Terraform Apply"
          workingDirectory: $(Build.SourcesDirectory)

# Stage 5: Configure NGINX via Ansible
- stage: ConfigureNginx
  displayName: "Configure NGINX via Ansible"
  dependsOn: TerraformApply
  condition: succeeded()
  jobs:
    - job: AnsibleJob
      displayName: "Run Ansible NGINX Setup"
      steps:
        - checkout: self
        - script: |
            sudo apt-get update
            sudo apt-get install -y ansible
            ansible --version
          displayName: "Install Ansible"
        - script: |
            cd $(ansible_folder)
            ansible-playbook -i inventory site.yml
          displayName: "Run NGINX Playbook"
          workingDirectory: $(Build.SourcesDirectory)

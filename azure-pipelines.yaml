trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  terraformVersion: '1.6.6'
  terraform_folder: 'terraform'   # adjust this after you see the debug output
  ansible_folder: 'ansible'
  location: 'westeurope'
  resource_group: 'demo-rg'
  vm_name: 'demo-vm'
  ssh_public_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDSgIiTUa…your_key_here…'

jobs:
- job: TerraformAndAnsible
  displayName: Terraform + Ansible
  steps:

    # 1. Checkout your repo
    - checkout: self

    # 2. Debug: list all files and folders
    - bash: |
        echo "===== Workspace contents ====="
        ls -R .
      displayName: "List files for debugging"

    # 3. Install Terraform CLI locally
    - bash: |
        set -e
        echo "Downloading Terraform $(terraformVersion)..."
        rm -rf terraform terraform.zip
        curl -sSLo terraform.zip \
          https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
        unzip -o terraform.zip
        chmod +x terraform
        mkdir -p $HOME/bin
        mv terraform $HOME/bin/terraform
        rm terraform.zip
        export PATH="$HOME/bin:$PATH"
        echo "✅ Terraform installed:"
        terraform -version
      displayName: "Install Terraform CLI"

    # 4. Terraform Init
    - bash: |
        set -e
        echo "Running terraform init..."
        cd $(terraform_folder)
        terraform init
      displayName: "Terraform Init"

    # 5. Terraform Plan
    - bash: |
        set -e
        echo "Running terraform plan..."
        cd $(terraform_folder)
        terraform plan \
          -var="location=$(location)" \
          -var="resource_group_name=$(resource_group)" \
          -var="vm_name=$(vm_name)" \
          -var="ssh_public_key=$(ssh_public_key)"
      displayName: "Terraform Plan"

    # 6. Terraform Apply
    - bash: |
        set -e
        echo "Running terraform apply..."
        cd $(terraform_folder)
        terraform apply -auto-approve \
          -var="location=$(location)" \
          -var="resource_group_name=$(resource_group)" \
          -var="vm_name=$(vm_name)" \
          -var="ssh_public_key=$(ssh_public_key)"
      displayName: "Terraform Apply"

    # 7. Install & Run Ansible Playbook
    - bash: |
        set -e
        echo "Installing Ansible..."
        sudo apt-get update
        sudo apt-get install -y ansible
        echo "Running Ansible playbook..."
        cd $(ansible_folder)
        ansible-playbook -i inventory site.yml
      displayName: "Configure NGINX via Ansible"

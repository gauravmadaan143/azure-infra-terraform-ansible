trigger:
- main

variables:
  terraformVersion: '1.6.6'

stages:
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform"
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - bash: |
        echo "Installing Terraform locally..."
        rm -rf terraform terraform.zip
        curl -sLo terraform.zip https://releases.hashicorp.com/terraform/${terraformVersion}/terraform_${terraformVersion}_linux_amd64.zip
        unzip terraform.zip
        chmod +x terraform
        mkdir -p $HOME/bin
        mv terraform $HOME/bin/
        echo "##vso[task.prependpath]$HOME/bin"
        terraform -version
      displayName: 'Install Terraform CLI'

    - bash: |
        terraform init
      displayName: 'Terraform Init'

    - bash: |
        terraform plan -out=tfplan
      displayName: 'Terraform Plan'

    - bash: |
        terraform apply -auto-approve tfplan
      displayName: 'Terraform Apply'

- stage: AnsibleDeploy
  displayName: "Run Ansible Playbook"
  dependsOn: Terraform
  jobs:
  - job: AnsibleJob
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - bash: |
        echo "Running Ansible playbook (example)"
        # Install Ansible (if needed)
        sudo apt-get update && sudo apt-get install -y ansible
        # Run your playbook here
        ansible-playbook your-playbook.yml -i inventory.ini
      displayName: 'Run Ansible Playbook'

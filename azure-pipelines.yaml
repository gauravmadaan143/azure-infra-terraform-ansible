trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  terraformVersion: '1.6.6'
  terraform_folder: 'terraform'
  ansible_folder: 'ansible'
  location: 'westeurope'
  resource_group: 'demo-rg'
  vm_name: 'demo-vm'
  ssh_public_key: 'ssh-rsa AAAAB3...REDACTED...ho6Q== gauravmadaan143@gmail.com'
  my_ip_address: '89.64.12.157/32'

jobs:
- job: DeployInfra
  displayName: "Terraform + Ansible Job"
  steps:
    - checkout: self

    # ‚úÖ Install Terraform
    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: "$(terraformVersion)"

    # ‚úÖ Terraform Init (inside Azure context)
    - task: AzureCLI@2
      displayName: "Terraform Init"
      inputs:
        azureSubscription: 'terraform-spn'  # üîÅ Replace with your real service connection name
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        workingDirectory: $(Build.SourcesDirectory)/$(terraform_folder)
        inlineScript: |
          terraform init

    # ‚úÖ Terraform Plan (Azure context)
    - task: AzureCLI@2
      displayName: "Terraform Plan"
      inputs:
        azureSubscription: 'terraform-spn'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        workingDirectory: $(Build.SourcesDirectory)/$(terraform_folder)
        inlineScript: |
          terraform plan \
            -var="location=$(location)" \
            -var="resource_group_name=$(resource_group)" \
            -var="vm_name=$(vm_name)" \
            -var="ssh_public_key=$(ssh_public_key)" \
            -var="my_ip_address=$(my_ip_address)"

    # ‚úÖ Terraform Apply (Azure context)
    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: 'terraform-spn'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        workingDirectory: $(Build.SourcesDirectory)/$(terraform_folder)
        inlineScript: |
          terraform apply -auto-approve \
            -var="location=$(location)" \
            -var="resource_group_name=$(resource_group)" \
            -var="vm_name=$(vm_name)" \
            -var="ssh_public_key=$(ssh_public_key)" \
            -var="my_ip_address=$(my_ip_address)"

    # ‚úÖ Install and Run Ansible
    - task: Bash@3
      displayName: "Install & Run Ansible"
      inputs:
        targetType: inline
        script: |
          sudo apt-get update
          sudo apt-get install -y ansible
          cd $(Build.SourcesDirectory)/$(ansible_folder)
          ansible-playbook -i inventory playbook.yaml

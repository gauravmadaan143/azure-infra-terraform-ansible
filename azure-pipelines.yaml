trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  terraform_folder: 'terraform'
  resource_group_name: 'demo-rg'
  location: 'westeurope'
  vm_name: 'demo-vm'
  ssh_public_key: 'ssh-rsa AAAAB3...REDACTED... gauravmadaan143@gmail.com'

stages:
- stage: TerraformInitAndPlan
  displayName: "Terraform Init and Plan"
  jobs:
    - job: Terraform
      displayName: "Run Terraform"
      steps:
        - checkout: self

        - task: Bash@3
          displayName: "Check Terraform Version"
          inputs:
            targetType: 'inline'
            script: |
              terraform -version

        - task: Bash@3
          displayName: "Terraform Init"
          inputs:
            targetType: 'inline'
            script: |
              cd $(terraform_folder)
              terraform init

        - task: Bash@3
          displayName: "Terraform Plan"
          inputs:
            targetType: 'inline'
            script: |
              cd $(terraform_folder)
              terraform plan \
                -var="location=$(location)" \
                -var="resource_group_name=$(resource_group_name)" \
                -var="vm_name=$(vm_name)" \
                -var="ssh_public_key=$(ssh_public_key)"

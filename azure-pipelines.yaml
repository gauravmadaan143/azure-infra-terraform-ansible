trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  terraformVersion: '1.6.6'
  terraform_folder: 'terraform'
  ansible_folder: 'ansible'
  location: 'westeurope'
  resource_group: 'demo-rg'
  vm_name: 'demo-vm'
  ssh_public_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDSgIiTUa…your_key_here…'

jobs:
- job: TerraformAndAnsible
  displayName: Terraform + Ansible
  steps:
    - checkout: self

    # 1. Debug to verify directory
    - bash: |
        echo "Sources directory contents:"
        ls -R $(Build.SourcesDirectory)
      displayName: "List $(Build.SourcesDirectory) for Debugging"

    # 2. Install Terraform CLI & Export PATH
    - bash: |
        set -e
        echo "Installing Terraform version $(terraformVersion)..."
        curl -sSLo terraform.zip https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
        unzip -o terraform.zip
        chmod +x terraform
        mkdir -p $(Build.SourcesDirectory)/bin
        mv terraform $(Build.SourcesDirectory)/bin/
        echo "✅ Terraform installed in $(Build.SourcesDirectory)/bin:"
        $(Build.SourcesDirectory)/bin/terraform -version
      displayName: "Install Terraform CLI"

    # 3. Terraform Init
    - bash: |
        set -e
        echo "Running terraform init..."
        cd $(Build.SourcesDirectory)/$(terraform_folder)
        terraform init
      displayName: "Terraform Init"
      env:
        PATH: $(Build.SourcesDirectory)/bin:$(PATH)

    # 4. Terraform Plan
    - bash: |
        set -e
        echo "Running terraform plan..."
        cd $(Build.SourcesDirectory)/$(terraform_folder)
        terraform plan \
          -var="location=$(location)" \
          -var="resource_group_name=$(resource_group)" \
          -var="vm_name=$(vm_name)" \
          -var="ssh_public_key=$(ssh_public_key)"
      displayName: "Terraform Plan"
      env:
        PATH: $(Build.SourcesDirectory)/bin:$(PATH)

    # 5. Terraform Apply
    - bash: |
        set -e
        echo "Running terraform apply..."
        cd $(Build.SourcesDirectory)/$(terraform_folder)
        terraform apply -auto-approve \
          -var="location=$(location)" \
          -var="resource_group_name=$(resource_group)" \
          -var="vm_name=$(vm_name)" \
          -var="ssh_public_key=$(ssh_public_key)"
      displayName: "Terraform Apply"
      env:
        PATH: $(Build.SourcesDirectory)/bin:$(PATH)

    # 6. Install & Run Ansible
    - bash: |
        set -e
        sudo apt-get update
        sudo apt-get install -y ansible
        cd $(Build.SourcesDirectory)/$(ansible_folder)
        ansible-playbook -i inventory playbook.yaml
      displayName: "Configure NGINX via Ansible"
